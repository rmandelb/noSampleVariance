\documentclass[preprint]{aastex}

%=====================================================================
% CUSTOM: PACKAGES, MACROS & SETTINGS
%=====================================================================

% packages for figures
\usepackage{graphicx}
% packages for symbols
\usepackage{latexsym,amssymb}
% AMS-LaTeX package for e.g. subequations
\usepackage{amsmath}

\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}
\newcommand{\hmsun}{\ensuremath{h^{-1}M_{\odot}}}
\newcommand{\hgpc}{$h^{-1}$Gpc}
\newcommand{\hmpc}{$h^{-1}$Mpc}
\newcommand{\hkpc}{$h^{-1}$kpc}
\newcommand{\kv}{\mathbf{k}}
\newcommand{\xv}{\mathbf{x}}
% \newcommand{\beq}{\begin{equation}}
% \newcommand{\eeq}{\end{equation}}

%%% Angular positions on the sky
\newcommand{\skyangle}{\phi}
%%% Initial conditions of the cosmological mass density
\newcommand{\rhoic}{\rho^{\rm IC}}
%%% Normal distribution
\newcommand{\normdist}{\mathcal{N}}
%%% Mean number density
\newcommand{\nbar}{\bar{n}}
%%% Mass threshold for cluster number counts
\newcommand{\mth}{M_{\rm th}}

%=====================================================================
% FRONT MATTER
%=====================================================================

\slugcomment{Draft \today}

%=====================================================================
% BEGIN DOCUMENT
%=====================================================================
\begin{document}

\title{Reducing sample variance in covariances}

\author{A bunch of DESC hackers}
\begin{abstract}
Something or other.
\end{abstract}

\section{Introduction}

Sarah will fill this in.  Rely on picture of first board and top of second board as well as our
discussions.  Actually I'm not sure how much info we need here, since 2.1 steps through the basic
idea.  Skip this?

\section{Math}

\subsection{Basic framework}
\beq
P(\vec{d}|\theta) = \int \mathrm{d}\rho^\text{IC}\int \mathrm{d}\rho(t) P(\vec{d}|\rho(t),\theta)
P(\rho(t)|\rho^\text{IC},\theta) P(\rho^\text{IC}|\theta).
\eeq
Here $\vec{d}$ is the data vector (e.g., the galaxy distribution and its properties, perhaps encoded
as cosmic shear correlation function or the galaxy 2-point
correlation function), $\theta$ are the cosmological parameters, $\rho^\text{IC}$ are the initial
conditions ($\rho^\text{IC}=\rho(t=\text{early})$), and $\rho(t)$ is the density at late times where we measure cosmic
shear.  All $\rho$ are also implicitly a function of position. Strictly speaking, all $\rho$ are to be understood as the values of three-dimensional random fields at every point in space. If these fields are evaluated at $M$ points, these probability distributions can be approximated as $M$-dimensional distributions of $\rho$ values. 
$P(\rho^\text{IC}|\theta)$ is a Gaussian random variable with mean $0$, which we can write as $N(0,S(\theta))$.  The key point is that
$P(\rho(t)|\rho^\text{IC},\theta)$ is purely deterministic (ignoring baryonic physics) - it's just
gravity acting on the matter distributed in a universe that is growing in a way determined by the
cosmological parameters.  So really it's a delta function,
\beq
P(\rho(t)|\rho^\text{IC},\theta) = \delta_D(\rho(t)-G(\rho^\text{IC}))
\eeq 
where we use $G$ to indicate the actions of gravity.  We use the delta function to eliminate one
integral, over $\rho(t)$, and get
\beq
P(\vec{d}|\theta) = \int \mathrm{d}\rho^\text{IC}  P(\vec{d}|\rho^\text{IC},\theta)N(0,S(\theta)).
\eeq
The basic idea is then to get a smaller variance by using some external data, such as massive
cluster counts, to get some idea of the ICs for the survey region.  In that case, we multiply by an
additional $P(d_\text{external}|\rho^\text{IC},\theta)$.  We then get
\beq
P(\vec{d},d_\text{external}|\rho^\text{IC},\theta) = P(\vec{d}|\rho^\text{IC},\theta)P(d_\text{external}|\rho^\text{IC},\theta),
\eeq
assuming independent errors.
The actual signals (the observed $\vec{d}$ and $d_\text{external}$) should ideally be highly
correlated, but their {\em uncertainties} should not.  For example, if the external info are counts
of high mass clusters, then the noise comes from Poisson error on X-ray counts or something like
that.  This is unrelated to shape noise in cosmic shear.


Let's say we want to evaluate the integral using Monte Carlo integration, where we carry out the
Monte Carlo integration using $N$ samples (in practice from $N$ simulations).  Without using that
external information, we can write the uncertainty on $P(\vec{d}|\theta)$ determined using $N$
simulations as
\beq
\text{Error}(P(\vec{d}|\theta)) \sim \frac{\text{Var}(P(\vec{d}|\rho^\text{IC},\theta))}{N}.
\eeq
Using that external information, it becomes
\beq
\text{Error}(P(\vec{d}|\theta)) \sim \frac{\text{Var}(P(\vec{d},d_\text{external}|\rho^\text{IC},\theta))}{N}.
\eeq
So if the variance is significantly smaller, then we might achieve a similar error on our
covariances with fewer simulations.  Note that this (reducing the error of Monte Carlo integration)
is not the goal of this project, really; we actually want to reduce the variance on our cosmological
model parameters in a real data analysis.  We're just using this formalism to get a rough estimate
on how much external data might help us.

So to summarize, if we can evaluate something like
\beq
\frac{\text{Var}(P(\vec{d},d_\text{external}|\rho^\text{IC},\theta))}{\text{Var}(P(\vec{d}|\rho^\text{IC},\theta))}
\eeq
then that tells us the fractional increase in the number of simulations needed for covariance
estimation.  i.e., if this ratio is $1$ then the extra information doesn't help, if this ratio is
$0.5$ then we need half as many sims, and so on.

The corresponding posteriors read
\begin{align}
P(\theta | \vec{d},d_\text{external},\rho^\text{IC}) &\propto P(\vec{d},d_\text{external}|\rho^\text{IC},\theta)\; P(\theta)\\
P(\theta | \vec{d},\rho^\text{IC}) &\propto P(\vec{d}|\rho^\text{IC},\theta)\; P(\theta)\;,
\end{align}
where $P(\theta)$ is the prior. Another useful figure of merit is
\beq
\frac{\text{Var}(P(\theta_i | \vec{d},d_\text{external}|\rho^\text{IC}))}{\text{Var}(P(\theta_i | \vec{d}|\rho^\text{IC}))}
\eeq
for any parameter $i$. A generalised metric could be based on the ratio of the determinants of the parameter covariances.



\subsection{An example case}

We are going to consider the case that the data vector is cosmic shear
\beq
%\vec{d} = \hat{\xi}_+(\phi)
\vec{d} = \hat{C}(\ell)
\eeq
and the external data are the counts of clusters above a mass threshold
\beq
d_\text{external} = \hat{n}_\text{clust}(M>M_\text{min} | \rho^\text{IC}) =
\int_{M_\text{min}}^{\infty} n(M)\,\mathrm{d}M.
\eeq

In this case,
\beq
P(\vec{d}|\rho^\text{IC},\theta) = N(\xi_+(G(\rho^\text{IC},\theta), \phi), \sigma^2_\gamma(\phi)).
\eeq
Here it's important to keep in mind that this is not $\bar{\xi}_+(\phi)$, the expected average correlation
function for a given cosmology.  It is the specific $\xi_+(\phi)$ {\em for the given set of ICs}. The
variance $\sigma^2_\gamma(\phi)$ is just shape noise.  For simplicity we might consider halo model
approximations for the 1-halo and 2-halo terms for the cosmic shear as written in the Mo et al. book
that Sukhdeep found.  

Likewise,
\beq
P(d_\text{external}|\rho^\text{IC},\theta) = N(\hat{n}_\text{clust}(M>M_\text{min} |
\rho^\text{IC}), \text{uncertainty based on cluster detection method}).
\eeq
We need to figure out that uncertainty.

Then we can write
\beq
P(\vec{d}|\rho^\text{IC},\theta)P(d_\text{external}|\rho^\text{IC},\theta)P(\rho^\text{IC}|\theta)
\propto P(\rho^\text{IC}|\vec{d},d_\text{external},\theta)
\eeq
\beq
\int \mathrm{d}\rho^\text{IC} P(\rho^\text{IC}|\vec{d},d_\text{external},\theta) = P(\vec{d}|\theta,
d_\text{external}).
\eeq


\subsection{Cosmic shear likelihood}

\beq
- \ln L = \frac{1}{2}\; \sum_{i,j=1}^{N_\ell} \left(  \hat{C}(\ell_i) - C_{\rm model}(\ell_i) \right)\; {\rm Cov}^{-1}\{  C(\ell_i), C(\ell_j) \}\; \left(  \hat{C}(\ell_j) - C_{\rm model}(\ell_j) \right)\;,
\eeq
where $N_\ell$ is the number of angular frequency bins.

\beq
{\rm Cov}\{  C(\ell_i), C(\ell_j) \}= \delta_{ij}\; \frac{4 \pi}{A_{\rm survey} \ell_i \Delta \ell}\; \left( C(\ell_i) + \frac{\sigma_\epsilon^2}{2 \bar{n}} \right)^2\;,
\eeq
where $\sigma_\epsilon$ is the dispersion if the complex ellipticity, and $\bar{n}$ the mean number density of the source galaxy sample.



\subsection{Halo mass function}
\citet{lima2004} present the probability distribution of the cluster number counts.


\subsection{Dependence on mass density phases} % (fold)
\label{sub:dependence_on_mass_density_phases}
We need to calculate the shear two-point function $\xi(\skyangle, \rhoic)$, 
the halo mass function $n(m, \rhoic)$
and the halo bias $b(m, \rhoic)$ as functions of the initial conditions of the 
cosmological mass density $\rhoic$. 
Because the traditional two-point function estimator averages over the phases 
of the mass density, we primarily care about the phases of the super-survey 
modes. This is the `super-sample covariance' discussed by 
\citet{takada2013}.

\subsubsection{Power spectrum fluctuations}
We're really interested in how the 3D mass density fluctuations change the
shear correlation function, the halo mass function, \emph{and their 
cross-covariances}. But, we can make a reasonable simplifying assumption that 
the effect of un-marginalized mass density fluctuations is to change the mean density 
in an observed survey volume. 
\begin{equation}
	P(k) \rightarrow P(k) \left(
	1 + \frac{\partial \ln P(k)}{\partial \delta_b} \delta_b\right)
\end{equation}

\begin{equation}
	\delta_b \sim \normdist
	\left(0, \left(\sigma_W^L\right)^{2}\right)
\end{equation}
where,
\begin{equation}
	\left(\sigma_{W}^{L}\right)^{2} \equiv
	\frac{1}{V_{W}^{2}} 
	\int \frac{d^{2}\kv}{(2\pi)^3}
	\left|W(\kv)\right|^{2}
	P^{L}(k).
\end{equation}

For the 2-halo term~\citep[eq. 39 of][]{takada2013}, 
\begin{equation}
	\frac{\partial \ln P(k)}{\partial \delta_b} \approx 
	\frac{68}{21}
\end{equation}

\subsubsection{Cluster counts fluctuations}
The number density of clusters of a given mass $m$ and redshift $z$ over the 
sky can be approximated as,
\begin{equation}
	n_{h}(\xv, m, z) \approx \nbar_{h}(m, z)
	\left[1 + b_{h}(m,z) \delta(\xv, z)\right],
\end{equation}
where $b_{h}(m,z)$ is the linear halo bias and
$\delta(\xv,z)$ is the mass overdensity.

We will use observations of the number of clusters above a 
specified mass threshold $\mth$,
\begin{equation}
	\bar{N}(z) \equiv
	\int_{\mth}^{\infty} dm\, 
	\nbar_{h}(m,z)
	\left[
	1 + b_{h}(m,z)
	\int d^{3}x\, W(\xv) \delta(\xv)
	\right]
\end{equation}

% subsection dependence_on_mass_density_phases (end)

\bibliographystyle{apj}
\bibliography{noSampleVariance}

\end{document}
% 